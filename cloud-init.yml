#cloud-config

ssh_pwauth: false
package_update: true
package_upgrade: true
package_reboot_if_required: true
packages:
  - xubuntu-core
  - software-properties-common
  - x2goserver
  - x2goserver-xsession
  - x2goserver-desktopsharing
  - firefox
  - flatpak
  - git
  - lazygit
  - docker.io
  - python
  - python3.8
  - python3-pip
  - meld
  - curl
  - gconf2
    
snap:
  commands:
    - ['install', '--classic', '--edge', 'intellij-idea-ultimate']
    - ['install', '--classic', 'pycharm-professional']
    - ['install', '--classic', 'code']
    - ['install', 'typora']
    - ['install', 'postman']

write_files:
  - content: |
      [Desktop Entry]
      Version=1.0
      Name=Mob Timer
      Exec=/home/mob/mob-timer-linux-x64/mob-timer
      Icon=/home/mob/mob-timer-linux-x64/resources/app/icon.ico
      Terminal=false
      Type=Application
      Categories=Application;Development
    path: /usr/share/applications/mob-timer.desktop
  - content: |
      #!/bin/bash
      
      launcher_plugins=()
      
      next_plugin_id () {
        local highest_number=$(xfconf-query -c xfce4-panel -p /plugins -l | cut -d"-" -f2 | cut -d"/" -f1 | sort -V -r | head -n 1)
        plugin_id=$((highest_number + 1))
      }
      
      create_launcher_plugin () {
        next_plugin_id
        mkdir ~/.config/xfce4/panel/launcher-$plugin_id
        cp $1 ~/.config/xfce4/panel/launcher-$plugin_id
        xfconf-query -c xfce4-panel -p /plugins/plugin-$plugin_id -t string -s "launcher" --create
        xfconf-query -c xfce4-panel -p /plugins/plugin-$plugin_id/items -t string -s "$(basename "${1%.*}").desktop" -a --create
        launcher_plugins+=("$plugin_id")
      }
      
      create_launcher_plugin "/usr/share/applications/firefox.desktop"
      create_launcher_plugin "/usr/share/applications/google-chrome.desktop"
      create_launcher_plugin "/var/lib/snapd/desktop/applications/intellij-idea-ultimate_intellij-idea-ultimate.desktop"
      create_launcher_plugin "/var/lib/snapd/desktop/applications/pycharm-professional_pycharm-professional.desktop"
      create_launcher_plugin "/var/lib/snapd/desktop/applications/code_code.desktop"
      create_launcher_plugin "/usr/share/applications/vim.desktop"
      create_launcher_plugin "/var/lib/snapd/desktop/applications/typora_typora.desktop"
      create_launcher_plugin "/usr/share/applications/org.gnome.meld.desktop"
      create_launcher_plugin "/var/lib/snapd/desktop/applications/postman_postman.desktop"
      create_launcher_plugin "/usr/share/applications/mob-timer.desktop"
      create_launcher_plugin "/var/lib/flatpak/exports/share/applications/com.anydesk.Anydesk.desktop"
      
      plugins_string=""
      
      for plugin in "${launcher_plugins[@]}"
      do
        plugins_string="${plugins_string} -t int -s ${plugin} "
      done
      
      ## clear panel 2
      xfconf-query -c xfce4-panel -p /panels/panel-2/plugin-ids -rR
      
      ## refill panel 2
      xfconf-query -c xfce4-panel -p /panels/panel-2/plugin-ids \
              -t int -s 15 \
              -t int -s 16 \
              -t int -s 17 \
              -t int -s 18 \
              $plugins_string \
              --create
      
      ## restart panel
      xfce4-panel -r

      ## Clear Shortcuts needed by IntelliJ
      xfconf-query -c xfce4-keyboard-shortcuts -p '/xfwm4/custom/<Alt>Insert' -r -R
      xfconf-query -c xfce4-keyboard-shortcuts -p '/xfwm4/custom/<Alt>Delete' -r -R
      setxkbmap -option caps:escape

    path: /opt/init-xfce4-panel.sh
    permissions: '0755'
  - content: |
      require('http').createServer(function (req, res) { res.end('UP'); }).listen(3000); 
    path: /opt/up.js
    permissions: '0755'

runcmd:
  - usermod -aG docker mob
  - chmod 666 /var/run/docker.sock
  - apt remove -y xfce4-screensaver
  - apt remove -y xfce4-power-manager
  - apt remove -y light-locker
  - flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
  - flatpak install -y flathub com.anydesk.Anydesk
  - wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
  - dpkg -i google-chrome-stable_current_amd64.deb
  - runuser -l mob -c 'curl -s "https://get.sdkman.io" | bash'
  - runuser -l mob -c 'source "$HOME/.sdkman/bin/sdkman-init.sh" ; sdk install java ; sdk install gradle ; sdk install maven'
  - runuser -l mob -c 'curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.38.0/install.sh | bash'
  - runuser -l mob -c 'bash -ic "nvm install node ; npm install --global yarn"'
  - runuser -l mob -c '/usr/bin/xfconf-query -c xsettings -p /Net/ThemeName -s "Adwaita-dark"'
  - runuser -l mob -c 'wget "https://github.com/gregorriegler/mob-timer/releases/download/linux/mob-timer-linux-x64.zip" -O temp.zip ; unzip temp.zip ; rm temp.zip'
  - runuser -l mob -c 'mkdir ~/.config/autostart'
  - runuser -l mob -c 'echo -e "[Desktop Entry]\nType=Application\nExec=/opt/init-xfce4-panel.sh\nName=Init xfce4 Panel\nComment=Init xfce4 Panel" | tee > ~/.config/autostart/init-xfce4-panel.desktop'
  - printf "<!DOCTYPE NXKeystroke>\n<keystrokes></keystrokes>\n" > /etc/x2go/keystrokes.cfg   
  - runuser -l mob -c 'bash -ic "node /opt/up.js &"'

apt:
  sources:
    lazygit.list:
      source: "ppa:lazygit-team/release"
    deadsnakes.list:
      source: "ppa:deadsnakes/ppa"

# TODO
# intellij k
# Xscreensaver k
# vscode k
# git k
# lg k
# sdkman k
# jdk k
# maven k
# gradle k
# nvm k
# node+npm k
# yarn k
# melddiff k
# mob-timer k
# google-chrome-stable k
# power management off k
# docker k
# python k
# pip k
# dark terminal k 
# dark layout k 
# 30 min no freeze test k
# caps -> escape k
# typora k
# postman k
# pycharm k
# github-cli
# anydesk password ?
# zsh + plugins
# Ping when done (end of cloud-init) k
# automatically destroy after 4 inactive hours
# C#:
# jetbrains raider
# dotNet 6
# sudo snap install dotnet-sdk --classic --channel=6.0
# vsCode omniCSharp
#
#
# Tips:
# Anydesk:
# Show remote Cursor
# Give up Mouse+Keyboard Control
# Hetzner
